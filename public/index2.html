<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alyce : An A.I fine tuned screenplay writer</title>
</head>
<body>
    <textarea id="input_story" rows="10" style="width: 90vw;"></textarea>
    <br/>
    <input type="button" id="submit_input_story" value="Submit 1"/>
    <br/>
    <div id="result"></div>
</body>
</html>
<script>
    var story = undefined;
    var story_list = undefined;
    var plot_index_list = [];
    var current_plotwords = [];
    var current_phase = 0;
    var current_data_server = 0;
    var active_clients = 0;
    var no_of_p1_servers = 0;
    var no_of_p2_servers = 0;
    var no_of_p3_servers = 0;
    var input_story = document.getElementById("input_story");
    var submit_button = document.getElementById("submit_input_story");


    function initialize_socket(){

        // Creating Socket Instance
        const socket = io();

        // Connecting To the Backend Server
        socket.on("connect", () => {

            // Informing The Server that the client is ready
            socket.emit("client-ready", "");

            // Event Listener to send data to server when user click submit button
            submit_button.onclick = function(){
                let input_data = input_story.value;
                if(input_data!=""){
                    socket.emit("client-to-server",{"phase": 1, "procedureNo": 0, "input": input_data});
                    story = input_data;
                }
                else{
                    window.alert("No Input Data!...");
                }
            }

            function call_phase_2_step_1(){
                socket.emit("client-to-server",{"phase": 2, "procedureNo": 0, "input": story_list});
            }

            function call_phase_2_step_2(){
                socket.emit("client-to-server",{"phase": 2, "procedureNo": 1, "input": current_plotwords});
            }

            // To get Information regarding the no of active connections
            socket.on("sub-servers-and-clients-status",function(data){
                active_clients = data.clients;
                no_of_p1_servers = data.P1_instances;
                no_of_p2_servers = data.P2_instances;
                no_of_p3_servers = data.P3_instances;
                console.log("Active Connections : "+active_clients+", "+no_of_p1_servers+", "+no_of_p2_servers+", "+no_of_p3_servers);
            });
        });

        socket.on("server-to-client",function(data){
            if(data.phase==1 && data.status=="STARTED"){
                current_phase = 1;
                current_data_server = 1;
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 1 Started";
            }
            else if(data.phase==1 && data.status=="COMPLETED"){
                current_data_server = 0;
                story_list = data.output;
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 1 Completed<br/>"+JSON.stringify(data);
                call_phase_2_step_1();
            }
            else if(data.phase==2 && data.procedureNo==0 && data.status=="STARTED"){
                current_phase = 2;
                current_data_server = 2;
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 2.1 Started";
            }
            else if(data.phase==2 && data.procedureNo==0 && data.status=="COMPLETED"){
                current_data_server = 0;
                story_list = data.output;
                plot_index_list = []
                current_plotwords = []
                for(i=0;i<story_list.length;++i){
                    if(story_list[i][1]=="PLOT"){
                        plot_index_list.push(i);
                        tmp = []
                        tmp.push(i)
                        tmp.push(story_list[i][2])
                        current_plotwords.push(tmp);
                    }
                }
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 2.1 Completed<br/>"+JSON.stringify(data);
                call_phase_2_step_2();
            }
            else if(data.phase==2 && data.procedureNo==1 && data.status=="STARTED"){
                current_phase = 2;
                current_data_server = 2;
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 2.2 Started";
            }
            else if(data.phase==2 && data.procedureNo==1 && data.status=="COMPLETED"){
                current_data_server = 0;
                // Plot Completed!......
                document.getElementById("result").innerHTML = document.getElementById("result").innerHTML + "<br/>Phase 2.2 Completed<br/>"+JSON.stringify(data);
                window.alert("Completed");
            }
        });

    }

    window.onload = function(){
        initialize_socket();
    }
</script>