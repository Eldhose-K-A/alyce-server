<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alyce: An A.I fine tuned Screenplay Writer</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    media="screen,projection">
  <link rel="stylesheet" type="text/css" href="/stylesheets/timeline.css" />
  <link rel="stylesheet" type="text/css" href="/stylesheets/index.css" />
</head>

<body class="loader">

  <!-- Header Section -->
  <header>
    <div class="row" style="background-color: #007bff;">
      <div class="col s12">
        &nbsp;
        <h3 class="center-text white-text">Alyce : An A.I fine tuned screenplay Writer</h3>
      </div>
    </div>
  </header>

  <!-- Content Input Section -->
  <section class="fullscreen">
    <div class="container">
      <div class="row">
        <div class="col-12">
          &nbsp;
          <form>
            <label for="input_story">Story Input Section</label>
            <textarea class="form-control" id="input_story" style="min-height: 50vh;"
              placeholder="Paste your story here!..."></textarea>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col s12 m6 l4 offset-l2">
          <button type="button" id="fetch_input_story" class="btn">Fetch Sample</button>
        </div>
        <div class="col s12 m6 l4">
          <button type="button" id="submit_input_story" class="btn">Send</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Scroll Location Marker -->
  <section id="outputsec">
    <div class="row">
      <div class="col-12">
        <hr />
      </div>
    </div>
  </section>

  <!-- Content Output Section -->
  <section class="fullscreen">
    <div class="paragraph__content-container">
      <h1>Process Overview</h1>
      <div class="paragraph__timeline">
        <div class="paragraph__timeline__container">
          <div id="phase00" class="paragraph__timeline__entry --entry-1 --is-pending">
            <span></span>
            <div class="paragraph__timeline__content-container">
              <div class="paragraph__timeline__content">
                <div class="paragraph__timeline__title">Response #01</div>
                <div id="progress_indicator_0" class="paragraph__timeline__info"></div>
                <div class="paragraph__timeline__name">- Alyce Server</div>
                <div class="paragraph__timeline__date-time">
                  <span class="paragraph__timeline__date">Step #1</span>
                  <span class="paragraph__timeline__time">Story<br />Received</span>
                </div>
              </div>
            </div>
          </div>
          <div id="phase01" class="paragraph__timeline__entry --entry-1 --is-pending">
            <span></span>
            <div class="paragraph__timeline__content-container">
              <div class="paragraph__timeline__content">
                <div class="paragraph__timeline__title">Response #02</div>
                <div id="progress_indicator_1" class="paragraph__timeline__info"></div>
                <div class="paragraph__timeline__name">- Alyce Server</div>
                <div class="paragraph__timeline__date-time">
                  <span class="paragraph__timeline__date">Step #2</span>
                  <span class="paragraph__timeline__time">Co-reference<br />Resolution</span>
                </div>
              </div>
            </div>
          </div>
          <div id="phase02" class="paragraph__timeline__entry --entry-1 --is-pending">
            <span></span>
            <div class="paragraph__timeline__content-container">
              <div class="paragraph__timeline__content">
                <div class="paragraph__timeline__title">Response #03</div>
                <div id="progress_indicator_2" class="paragraph__timeline__info"></div>
                <div class="paragraph__timeline__name">- Alyce Server</div>
                <div class="paragraph__timeline__date-time">
                  <span class="paragraph__timeline__date">Step #3</span>
                  <span class="paragraph__timeline__time">Plot<br />Generation</span>
                </div>
              </div>
            </div>
          </div>
          <div id="phase03" class="paragraph__timeline__entry --entry-1 --is-pending">
            <span></span>
            <div class="paragraph__timeline__content-container">
              <div class="paragraph__timeline__content">
                <div class="paragraph__timeline__title">Response #04</div>
                <div id="progress_indicator_3" class="paragraph__timeline__info"></div>
                <div class="paragraph__timeline__name">- Alyce Server</div>
                <div class="paragraph__timeline__date-time">
                  <span class="paragraph__timeline__date">Step #4</span>
                  <span class="paragraph__timeline__time">Audio<br />Generation</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Rewrite Control Section -->
  <section class="fullscreen">
    <h2>REWRITE SECTION</h2>
    <div id="rewrite_element_0"></div>
    <div id="rewrite_element_1"></div>
    <div id="rewrite_element_2"></div>
  </section>

  <!-- Data Log Section -->
  <section class="fullscreen">
    <div id="log_element"></div>
  </section>

  <!-- Footer Section -->
  <footer></footer>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/popper.js@1/dist/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://unpkg.com/tippy.js@4"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var rewrite_flag = false;
    var story = undefined;
    var story_list = undefined;
    var script_content = "";
    var audio_file_names = undefined;
    var plot_index_list = [];
    var current_plotwords = [];
    var current_phase = 0;
    var current_data_server = 0;
    var active_clients = 0;
    var no_of_p1_servers = 0;
    var no_of_p2_servers = 0;
    var no_of_p3_servers = 0;
    var input_story = document.getElementById("input_story");
    var submit_button = document.getElementById("submit_input_story");
    var rewrite_element_0 = document.getElementById("rewrite_element_0");
    var rewrite_element_1 = document.getElementById("rewrite_element_1");
    var rewrite_element_2 = document.getElementById("rewrite_element_2");
    var logger_element = document.getElementById("log_element");
    var call_phase_1_step_1 = undefined;
    var call_phase_2_step_1 = undefined;
    var call_phase_2_step_2 = undefined;
    var call_phase_3_step_1 = undefined;
    var timeline_label = [document.getElementById("phase00"), document.getElementById("phase01"), document
      .getElementById("phase02"), document.getElementById("phase03")
    ];
    var timeline_content = [document.getElementById("progress_indicator_0"), document.getElementById(
      "progress_indicator_1"), document.getElementById("progress_indicator_2"), document.getElementById(
      "progress_indicator_3")];

    // Code to Set the Tool tip of Timeline correctly
    function re_initialize_timeline() {
      console.log("Time Line Resetted!...");
      tippy('.paragraph__timeline:not(.--is-horizontal) .paragraph__timeline__entry.--is-completed', {
        content: 'Completed',
        placement: 'top'
      });
      tippy('.paragraph__timeline:not(.--is-horizontal) .paragraph__timeline__entry.--is-inprogress', {
        content: 'In Progress',
        placement: 'top'
      });
      tippy('.paragraph__timeline:not(.--is-horizontal) .paragraph__timeline__entry.--is-pending', {
        content: 'Pending',
        placement: 'top'
      });
    }

    function set_as_plot(plot_no, sublist_index) {
      story_list[plot_no][0] = story_list[plot_no][3][sublist_index];
      rewrite_element_0.innerHTML = story_list[plot_no][0] + "<br/>" +
        "<input type=\"button\" value=\"Write New Plot\" onclick=\"rewrite_plot(" + plot_no +
        ")\" /><input type=\"button\" value=\"close\" onclick=\"write_screenplay(2)\"/>";
    }

    function rewrite_plot(plot_no) {
      rewrite_flag = true;
      current_plotwords = [
        [plot_no, story_list[plot_no][2]]
      ];
      rewrite_element_2.innerHTML = rewrite_element_1.innerHTML + rewrite_element_2.innerHTML;
      rewrite_element_1.innerHTML = "";
      call_phase_2_step_2();
    }

    function open_rewrite_plot_dashboard(plot_no) {
      rewrite_element_0.innerHTML = story_list[plot_no][0] + "<br/>" +
        "<input type=\"button\" value=\"Write New Plot\" onclick=\"rewrite_plot(" + plot_no +
        ")\" /><input type=\"button\" value=\"close\" onclick=\"write_screenplay(2)\"/>";
      rewrite_element_1.innerHTML = "";
      var rewrite_element_content = "";
      for (i = story_list[plot_no][3].length - 1; i >= 0; --i) {
        rewrite_element_content = rewrite_element_content + "<br/><label>";
        rewrite_element_content = rewrite_element_content + "<input type=\"radio\" value=\"" + i +
          "\"  class=\"with-gap\" name=\"plotno\"  onclick=\"set_as_plot(" + plot_no + "," + i + ")\" />";
        rewrite_element_content = rewrite_element_content + "<span>" + story_list[plot_no][3][i] + "</span></label>";
      }
      rewrite_element_2.innerHTML = rewrite_element_content;
    }

    function write_screenplay(option) {
      script_content = "";
      sceneno = 1;
      if (story_list != undefined) {
        for (i = 0; i < story_list.length; ++i) {
          if (story_list[i][1] == "PLOT" && story_list[i][0] != "") {
            script_content = script_content + "<h3>SCENE : " + sceneno + "</h3>";
            sceneno = sceneno + 1;
            script_content = script_content + "<span style=\"color: red;\">" + story_list[i][0].trim() + "</span>";
            if(option==2){ 
              script_content = script_content + "&nbsp;<button onclick=\"open_rewrite_plot_dashboard(" + i + ")\">Rewrite</button>";
            }
            else if(option==3){
              script_content = script_content + "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
            }
          } else if (story_list[i][1] == "NARRATION") {
            if (i > 0 && story_list[i - 1] != "NARRATION")
              script_content = script_content + "<br/>";
            script_content = script_content + "<span style=\"color: green;\">" + story_list[i][0].trim() + "</span>";
            if(option==3){
              script_content = script_content + "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
            }
          } else if (story_list[i][1] == "DIALOGUE") {
            if (i > 0 && story_list[i - 1] != "DIALOGUE")
              script_content = script_content + "<br/>";
            script_content = script_content + "<b>" + story_list[i][4].trim() + " : </b>" + story_list[i][5].trim();
            if(option==3){
              script_content = script_content + "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
            }
          }
        }
        if(option==2){
          script_content = script_content + "<br/>&nbsp;<br/>&nbsp;<br/><button onclick=\"call_phase_3_step_1()\">Generate Audio Transcript</button>";
        }
      }
      logger_element.innerHTML = logger_element.innerHTML + script_content;
    }

    function write_screenplay_with_audio() {
      script_content = "";
      sceneno = 1;
      if (story_list != undefined) {
        for (i = 0; i < story_list.length; ++i) {
          if (story_list[i][1] == "PLOT" && story_list[i][0] != "") {
            script_content = script_content + "<h3>SCENE : " + sceneno + "</h3>";
            sceneno = sceneno + 1;
            script_content = script_content + "<span style=\"color: red;\">" + story_list[i][0].trim() + "</span>" +
              "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
          } else if (story_list[i][1] == "NARRATION") {
            if (i > 0 && story_list[i - 1] != "NARRATION")
              script_content = script_content + "<br/>";
            script_content = script_content + "<span style=\"color: green;\">" + story_list[i][0].trim() + "</span>" +
              "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
          } else if (story_list[i][1] == "DIALOGUE") {
            if (i > 0 && story_list[i - 1] != "DIALOGUE")
              script_content = script_content + "<br/>";
            script_content = script_content + "<b>" + story_list[i][4].trim() + " : </b>" + story_list[i][5].trim() +
              "<audio style=\"height: 15px;\" src='/audio/" + audio_file_names[i] + "' controls></audio>";
          }
        }
      }
      logger_element.innerHTML = logger_element.innerHTML + script_content;
    }

    $(document).ready(function () {
      $("body").removeClass('loader');

      re_initialize_timeline();

      initiate_socket_connection();

      // Event Listener to send data to server when user click submit button
      submit_button.onclick = function () {
        let input_data = input_story.value;
        if (input_data != "") {
          story = input_data;
          call_phase_1_step_1();
        } else {
          window.alert("No Input Data!...");
        }
      }

      // Code to fetch a sample story on Clicking Fetch Button
      $("#fetch_input_story").click(function () {
        $.ajax({
          url: "/story/story01.txt",
          success: function (result) {
            $("#input_story").html(result);
          }
        });
      });

    });

    function initiate_socket_connection() {

      // Creating Socket Instance
      const socket = io();

      // Connecting To the Backend Server
      socket.on("connect", () => {

        // Informing The Server that the client is ready
        socket.emit("client-ready", "");

        call_phase_1_step_1 = function () {
          timeline_label[0].classList.remove("--is-pending");
          timeline_label[0].classList.add("--is-inprogress");
          socket.emit("client-to-server", {
            "phase": 1,
            "procedureNo": 0,
            "input": story
          });
        }

        call_phase_2_step_1 = function () {
          socket.emit("client-to-server", {
            "phase": 2,
            "procedureNo": 0,
            "input": story_list
          });
        }

        call_phase_2_step_2 = function () {
          socket.emit("client-to-server", {
            "phase": 2,
            "procedureNo": 1,
            "input": current_plotwords
          });
        }

        call_phase_3_step_1 = function () {
          socket.emit("client-to-server", {
            "phase": 3,
            "procedureNo": 0,
            "input": story_list
          });
        }

      });

      socket.on("sub-servers-and-clients-status", function (data) {
        active_clients = data.clients;
        no_of_p1_servers = data.P1_instances;
        no_of_p2_servers = data.P2_instances;
        no_of_p3_servers = data.P3_instances;
        console.log("Active Connections : " + active_clients + ", " + no_of_p1_servers + ", " + no_of_p2_servers +
          ", " + no_of_p3_servers);
      });

      socket.on("server-to-client", function (data) {

        if (data.error == true) {
          window.alert("ERROR : " + data.errormsg);
          return;
        }

        if (data.phase == 1 && data.status == "STARTED") {
          current_phase = 1;
          current_data_server = 1;
          timeline_label[0].classList.remove("--is-inprogress");
          timeline_label[0].classList.add("--is-completed");
          timeline_label[1].classList.remove("--is-pending");
          timeline_label[1].classList.add("--is-inprogress");
          re_initialize_timeline();
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 1 Started</b>";
          timeline_content[0].innerHTML = "Input Received at Server";
        } else if (data.phase == 1 && data.status == "COMPLETED") {
          current_data_server = 0;
          timeline_label[1].classList.remove("--is-inprogress");
          timeline_label[1].classList.add("--is-completed");
          re_initialize_timeline();
          story_list = data.output;
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 1 Completed</b><br/>" + JSON
            .stringify(data);
          write_screenplay(1);
          timeline_content[1].innerHTML = script_content;
          call_phase_2_step_1();
        } else if (data.phase == 2 && data.procedureNo == 0 && data.status == "STARTED") {
          current_phase = 2;
          current_data_server = 2;
          timeline_label[2].classList.remove("--is-pending");
          timeline_label[2].classList.add("--is-inprogress");
          re_initialize_timeline();
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 2.1 Started</b>";
        } else if (data.phase == 2 && data.procedureNo == 0 && data.status == "COMPLETED") {
          current_data_server = 0;
          story_list = data.output;
          plot_index_list = []
          current_plotwords = []
          for (i = 0; i < story_list.length; ++i) {
            if (story_list[i][1] == "PLOT") {
              plot_index_list.push(i);
              tmp = []
              tmp.push(i)
              tmp.push(story_list[i][2])
              current_plotwords.push(tmp);
            }
          }
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 2.1 Completed</b><br/>" + JSON
            .stringify(data);
          call_phase_2_step_2();
        } else if (data.phase == 2 && data.procedureNo == 1 && data.status == "STARTED") {
          current_phase = 2;
          current_data_server = 2;
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 2.2 Started</b>";
        } else if (data.phase == 2 && data.procedureNo == 1 && data.status == "COMPLETED") {
          current_data_server = 0;
          if (rewrite_flag == true) {
            story_list[data.output[0][0]][3].push(data.output[0][1]);
            /*rewrite_element_1.innerHTML = "<br/><input type=\"radio\" style=\"opacity: 1 !important;\" value=\"" + (story_list[data.output[0][0]][3].length -
              1) + "\" onclick=\"set_as_plot(" + data.output[0][0] + "," + (story_list[data.output[0][0]][3]
              .length -
              1) + ")\" /> &emsp;&emsp; : " + data.output[0][1];*/
            rewrite_element_1.innerHTML = "<br/><label><input type=\"radio\" class=\"with-gap\" value=\"" + (
                story_list[data.output[0][0]][3].length - 1) + "\" onclick=\"set_as_plot(" + data.output[0][0] +
              "," + (story_list[data.output[0][0]][3].length - 1) + ")\" /><span>" + data.output[0][1] +
              "</span></label>";
            rewrite_flag = false;
          } else {
            timeline_label[2].classList.remove("--is-inprogress");
            timeline_label[2].classList.add("--is-completed");
            re_initialize_timeline();
            for (i = 0; i < data.output.length; ++i) {
              if (data.output[i][1] != "") {
                story_list[data.output[i][0]][0] = data.output[i][1];
                story_list[data.output[i][0]][3].push(data.output[i][1]);
              }
            }
            logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 2.2 Completed</b><br/>" + JSON
              .stringify(data);
            logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 2.2 Completed StoryList</b><br/>" +
              JSON.stringify(story_list);
            write_screenplay(2);
            timeline_content[2].innerHTML = script_content;
          }
        } else if (data.phase == 3 && data.status == "STARTED") {
          current_phase = 3;
          timeline_label[3].classList.remove("--is-pending");
          timeline_label[3].classList.add("--is-inprogress");
          re_initialize_timeline();
          current_data_server = 3;
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 3 Started</b>";
        } else if (data.phase == 3 && data.status == "COMPLETED") {
          current_data_server = 0;
          timeline_label[3].classList.remove("--is-inprogress");
          timeline_label[3].classList.add("--is-completed");
          re_initialize_timeline();
          audio_file_names = data.output;
          logger_element.innerHTML = logger_element.innerHTML + "<br/><b>Phase 3 Completed</b>";
          write_screenplay(3);
          timeline_content[3].innerHTML = script_content;
        }

      });

    }
  </script>
</body>

</html>